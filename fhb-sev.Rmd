---
title: "Meta-analysis of fungicide efficacy for FHB control in Brazil"
output: github_document
---

```{r, warning=FALSE, include=FALSE}

# Load packages 
library(tidyverse)
library(metafor)
library(knitr)
library(ggthemes)
library(cowplot)
library(scales)
```


## Introduction



## Import data

```{r}

# import data
fhb_sev <- read.csv("fhb_sev.csv", sep = ",", h =T)

```


## Create MA variables


### Effect size (yi) and id variable for the treatment
```{r}
fhb_sev$yi <- log(fhb_sev$sev)
fhb_sev$id <- 1:nrow(fhb_sev)
```

### Sampling variance (vi)
```{r}
fhb_sev$L.var_sev2 <- with(fhb_sev, V_sev/(n * sev^2))
fhb_sev$vi <- fhb_sev$L.var_sev2
```

### Create the fungicide treatment variables 

```{r}
# Check the number of entries by fungicide (AI: active ingredient) and number of sprays
table(fhb_sev$AI, fhb_sev$n_spray2)

# create treatment variable (AI_nspray2) based on fungicide and number of sprays 
fhb_sev <- fhb_sev %>% 
  mutate(AI_nspray2 = paste(AI, n_spray2,sep='_')) %>% 
  filter(AI_nspray2 != "CARB_1") %>% 
  filter(trial, length(trial)>1) 

# four treatments were created with 22 to 35 entries each
table(fhb_sev$AI_nspray2)

```

## Calculate coefficient of variation of FHB index

```{r}
## All entries
cv <- (sd(fhb_sev$sev)/mean(fhb_sev$sev))*100
cv

## Only non-treated check
cv <- (sd(fhb_sev$sev_check)/mean(fhb_sev$sev_check))*100
cv

```

## Network meta-analysis

### Mean log of FHB index

```{r}
fhb_mv_AI <- rma.mv(yi, vi, mods = ~ AI_nspray2, method="ML",random = list(~ AI_nspray2 | trial, ~1 | id), struct="UN", data=fhb_sev)

# Linear contrasts between pairs of treatments
anova(fhb_mv_AI, L=rbind(c(0,1,-1,0,0), 
                         c(0,0,-1,1,0),
                         c(0,0,-1,0,1),
                         c(0,0,0,-1,1)))  


```

## Control efficacy
Bback-transforming difference of the logs

```{r}
results_AI <- data.frame(cbind((1-exp(fhb_mv_AI$b))*100, 
                              (1-exp(fhb_mv_AI$ci.lb))*100,
                              (1-exp(fhb_mv_AI$ci.ub))*100))
results_AI
```


## Inconsistency test

```{r, eval=FALSE, include=FALSE}
 
### Number of trials per design (cons_group)
table(fhb_sev$cons_group)


### Model testing interaction treat x design
fhb_mv_AI_cons <- rma.mv(yi, vi, mods = ~ AI_nspray2 * cons_group, method="ML",random = ~ AI_nspray2 | trial/cons_group, struct="UN", data=fhb_sev)
summary(fhb_mv_AI_cons)

results_I<- data.frame(cbind((exp(fhb_mv_AI$b)-1)*100, 
                             (exp(fhb_mv_AI$ci.lb)-1)*100,
                             (exp(fhb_mv_AI$ci.ub)-1)*100))

results_I
anova(fhb_mv_AI_cons, btt=11:20) #p-val = 0.9999


```

  

## Moderator variables


### FHB index base


```{r, message=FALSE, warning=FALSE}
# create the binary variable (dis_press)
fhb_sev$dis_press <- ifelse(as.numeric(fhb_sev$sev_check) >7.0, 2, 1)

# summarize number of trials per category of dis_press
table(fhb_sev$AI_nspray2, fhb_sev$dis_press)

# Test effect of moderator 
fhb_mv_AI_sev_check <- rma.mv(yi, vi, mods = ~ AI_nspray2*factor(dis_press), method="ML",random = list(~ AI_nspray2 | trial, ~1 | id), struct="UN", data=fhb_sev)


# Contrast levels of moderators
anova(fhb_mv_AI_sev_check,btt=7:10)


```

### Yield base

```{r, message=FALSE, warning=FALSE}
# create binary variable (yield_class)
summary(fhb_sev$yield_check) # Median = 2993; Mean = 2915
fhb_sev$yield_class <- ifelse(fhb_sev$yield_check > 3000, 2, 1)

# check number of trials per yield_class category
table(fhb_sev$yield_class, fhb_sev$AI_nspray2)

# test the effect of moderator
fhb_mv_AI_yield_class <- rma.mv(yi, vi, mods = ~ AI_nspray2*factor(yield_class), method="ML",random = list(~ AI_nspray2 | trial, ~1 | id), struct="UN", data=fhb_sev)

anova(fhb_mv_AI_yield_class, btt=7:10) 

```


### Year as continuous 

```{r, message=FALSE, warning=FALSE}
# Moderator year (continuous)
# Number of entries by fungicide and year
table(fhb_sev$AI_nspray2, fhb_sev$year)

fhb_mv_AI_year <- rma.mv(yi, vi, mods = ~ AI_nspray2*as.numeric(year), method="ML",random =list(~ AI_nspray2 | trial, ~1 | id), struct="UN", data=fhb_sev)


anova(fhb_mv_AI_year, btt=7:10)

```


## Visualize the data

###Boxplot of severity by treatment

```{r}
ggplot(fhb_sev, aes(AI_nspray2, sev))+
  geom_boxplot(size = 0.5, outlier.shape = NA)+ 
  geom_jitter(width=0.1, shape=1, size=2.5, color="gray50")+
  scale_x_discrete(labels=c("CHECK","CARB 2x", "PROP 2x" ,"TEBU 1x","TEBU 2x")) +
  theme_classic()+
  xlab("")+
  ylab("FHB index (%)")+ 
  scale_y_continuous(breaks=c(0, 10,  20,  30, 40, 50, 60, 70, 80, 90, 100), limits=c(0,100))
  
```
